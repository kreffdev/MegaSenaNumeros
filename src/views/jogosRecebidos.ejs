<%- include('includes/head'); %>
<%- include('includes/nav'); %>

<main class="meus-jogos-container">
    <div class="meus-jogos-header">
        <div class="header-content">
            <h1>Jogos Recebidos</h1>
            <% if (user) { %>
                <p class="user-info">Bem-vindo, <strong><%= user.username %></strong></p>
            <% } %>
        </div>
    </div>

    <% if (jogos.length === 0) { %>
        <div class="empty-state">
            <div class="empty-icon">üì®</div>
            <h2>Nenhum jogo recebido ainda</h2>
            <p>Voc√™ ainda n√£o recebeu nenhuma sequ√™ncia de n√∫meros.</p>
            <a href="/" class="btn-criar-novo">Voltar √† P√°gina Principal</a>
        </div>
    <% } else { %>
        <div class="jogos-stats">
            <div class="stat-card">
                <span class="stat-label">Total de Jogos Recebidos</span>
                <span class="stat-value"><%= jogos.length %></span>
            </div>
            <div class="stat-card">
                <span class="stat-label">√öltimo Jogo</span>
                <span class="stat-value">
                    <% 
                    const dataUltima = new Date(jogos[0].dataEnvio);
                    const hoje = new Date();
                    const diferenca = Math.floor((hoje - dataUltima) / (1000 * 60 * 60 * 24));
                    if (diferenca === 0) { %>
                        Hoje
                    <% } else if (diferenca === 1) { %>
                        Ontem
                    <% } else { %>
                        <%= diferenca %> dias atr√°s
                    <% } %>
                </span>
            </div>
        </div>

        <div class="jogos-grid">
            <% jogos.forEach((jogo, index) => { %>
                <div class="jogo-card jogo-recebido" data-jogo-id="<%= jogo._id %>">
                    <div class="jogo-checkbox-container">
                        <input type="checkbox" class="checkbox-aposta" onchange="marcarAposta(this)">
                        <span class="aposta-label">aposta feita</span>
                    </div>

                    <div class="jogo-header">
                        <span class="jogo-numero">#<%= index + 1 %></span>
                        <span class="jogo-data">
                            <% 
                            const data = new Date(jogo.dataEnvio);
                            const dia = String(data.getDate()).padStart(2, '0');
                            const mes = String(data.getMonth() + 1).padStart(2, '0');
                            const ano = data.getFullYear();
                            const horas = String(data.getHours()).padStart(2, '0');
                            const minutos = String(data.getMinutes()).padStart(2, '0');
                            %>
                            <%= dia %>/<%= mes %>/<%= ano %> √†s <%= horas %>:<%= minutos %>
                        </span>
                    </div>

                    <div class="jogo-origem">
                        <span class="origem-label">üì¨ Enviado por:</span>
                        <span class="origem-usuario"><%= jogo.enviadoPor.username %></span>
                    </div>
                    
                    <div class="jogo-numeros">
                        <% jogo.numeros.forEach(numero => { %>
                            <span class="numero-badge"><%= numero %></span>
                        <% }); %>
                    </div>
                    
                    <div class="jogo-actions">
                        <button class="btn-copiar" onclick="copiarNumeros('<%= jogo.numeros.join(', ') %>')" title="Copiar n√∫meros">
                            üìã Copiar
                        </button>
                        <button class="btn-deletar" onclick="deletarJogoRecebido('<%= jogo._id %>')" title="Deletar jogo">
                            üóëÔ∏è Deletar
                        </button>
                    </div>
                </div>
            <% }); %>
        </div>

        <div class="jogos-footer">
            <button class="btn-deletar-todos" onclick="deletarTodosRecebidos()" title="Deletar todos os jogos recebidos">
                üóëÔ∏è Deletar Todos os Recebidos
            </button>
        </div>
    <% } %>

    <div class="volta-home">
        <a href="/" class="btn-voltar">‚Üê Voltar √† P√°gina Principal</a>
    </div>
</main>

<script>
    function copiarNumeros(numeros) {
        navigator.clipboard.writeText(numeros).then(() => {
            alert('‚úì N√∫meros copiados para a √°rea de transfer√™ncia!');
        }).catch(() => {
            alert('‚úó Erro ao copiar. Tente novamente.');
        });
    }

    function marcarAposta(checkbox) {
        const card = checkbox.closest('.jogo-card');
        if (checkbox.checked) {
            card.classList.add('aposta-feita');
        } else {
            card.classList.remove('aposta-feita');
        }
    }

    function deletarJogoRecebido(jogoId) {
        if (!confirm('Tem certeza que deseja deletar este jogo recebido?')) {
            return;
        }

        const card = document.querySelector(`[data-jogo-id="${jogoId}"]`);
        card.classList.add('deleting');

        fetch(`/api/jogos-recebidos/${jogoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    card.remove();
                    // Se n√£o houver mais cards, recarrega a p√°gina
                    if (document.querySelectorAll('.jogo-card').length === 0) {
                        location.reload();
                    }
                }, 300);
            } else {
                alert(`‚úó Erro: ${data.mensagem}`);
                card.classList.remove('deleting');
            }
        })
        .catch(erro => {
            console.error('Erro:', erro);
            alert('‚úó Erro ao deletar jogo');
            card.classList.remove('deleting');
        });
    }

    function deletarTodosRecebidos() {
        if (!confirm('Tem certeza que deseja deletar TODOS os jogos recebidos? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }

        fetch('/api/jogos-recebidos/deletar-todos', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert(`‚úì ${data.mensagem}`);
                location.reload();
            } else {
                alert(`‚úó ${data.mensagem}`);
            }
        })
        .catch(erro => {
            console.error('Erro:', erro);
            alert('‚úó Erro ao deletar jogos recebidos');
        });
    }
</script>

<%- include('includes/footer'); %>

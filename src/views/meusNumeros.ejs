<%- include('includes/head'); %>
<%- include('includes/nav'); %>

<!-- Modal de vencedor -->
<div id="modal-vencedor" class="modal-vencedor">
    <div class="modal-vencedor-content">
        <div class="modal-vencedor-header">
            <span class="modal-vencedor-icon">ğŸ‰</span>
            <h2 class="modal-vencedor-titulo">PARABÃ‰NS!</h2>
            <p class="modal-vencedor-subtitulo">VocÃª tem uma sequÃªncia vencedora!</p>
            <p class="modal-vencedor-usuario"><span>SequÃªncia de:</span> VocÃª</p>
        </div>
        <div class="modal-vencedor-body">
            <p class="vencedor-label">NÃºmeros sorteados:</p>
            <div class="vencedor-numeros">
                <!-- NÃºmeros serÃ£o inseridos aqui dinamicamente -->
            </div>
        </div>
        <div class="modal-vencedor-footer">
            <button class="btn-fechar-vencedor" onclick="__fecharPopupVencedorSafe()">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal de envio de jogos -->
<div id="modal-enviar-jogos" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Enviar Meus Jogos</h2>
            <button class="modal-close" onclick="fecharModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Digite o nome do usuÃ¡rio para o qual deseja enviar seus jogos:</p>
            <input type="text" id="nome-usuario-envio" placeholder="Nome do usuÃ¡rio" class="modal-input">
        </div>
        <div class="modal-footer">
            <button class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
            <button class="btn-confirmar" onclick="enviarJogos()">Enviar</button>
        </div>
    </div>
</div>

<main class="meus-jogos-container">
    <div class="meus-jogos-header">
        <div class="verifica-numeros">
            <input type="text" id="verifica-numeros-input" placeholder="Ex: 05,12,23,34,45,56" aria-label="Verificar nÃºmeros">
            <button class="btn-verificar" title="Verificar NÃºmeros">
                ğŸ” Verificar
            </button>
        </div>

        <div class="header-content">
            <h1>Meus NÃºmeros</h1>
            <% if (user) { %>
                <p class="user-info">Bem-vindo, <strong><%= user.username %></strong></p>
            <% } %>
        </div>

        <button class="btn-enviar-jogos" title="Enviar meus jogos" onclick="abrirModal()">
            ğŸ“¤ Enviar Meus Jogos
        </button>
    </div>

    <% if (jogos.length === 0) { %>
        <div class="empty-state">
            <div class="empty-icon">ğŸ²</div>
            <h2>Nenhuma sequÃªncia salva ainda</h2>
            <p>VocÃª ainda nÃ£o salvou nenhuma sequÃªncia de nÃºmeros.</p>
            <a href="/" class="btn-criar-novo">Criar uma SequÃªncia</a>
        </div>
    <% } else { %>
        <div class="jogos-stats">
            <div class="stat-card">
                <span class="stat-label">Total de SequÃªncias</span>
                <span class="stat-value"><%= jogos.length %></span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Valor Total das Apostas</span>
                <span class="stat-value">R$ <%= jogos.reduce((total, jogo) => total + getInfoModalidade(jogo.modalidade || 'megasena').precoMinimo, 0).toFixed(2).replace('.', ',') %></span>
            </div>
        </div>

        <div class="jogos-grid">
            <% jogos.forEach((jogo, index) => { %>
                <div class="jogo-card<%= jogo.apostaMarcada ? ' aposta-feita' : '' %>" data-jogo-id="<%= jogo._id %>" data-modalidade="<%= jogo.modalidade || 'megasena' %>">
                        <% 
                        const modalidadeInfo = getInfoModalidade(jogo.modalidade || 'megasena');
                        const data = new Date(jogo.criadoEm);
                        const dia = String(data.getDate()).padStart(2, '0');
                        const mes = String(data.getMonth() + 1).padStart(2, '0');
                        const ano = data.getFullYear();
                        const horas = String(data.getHours()).padStart(2, '0');
                        const minutos = String(data.getMinutes()).padStart(2, '0');
                        %>

                        <div class="jogo-header">
                            <div class="jogo-row1">
                                <div class="jogo-numero">#<%= index + 1 %></div>
                                <div class="jogo-data"><%= dia %>/<%= mes %>/<%= ano %> Ã s <%= horas %>:<%= minutos %></div>
                                <div class="jogo-aposta">
                                    <label class="jogo-checkbox-inline">
                                        <input type="checkbox" class="checkbox-aposta" onchange="marcarApostaPropria(this)" <%= jogo.apostaMarcada ? 'checked disabled' : '' %>>
                                        <span class="aposta-label">aposta feita</span>
                                    </label>
                                </div>
                            </div>

                            <div class="jogo-row2">
                                <div class="jogo-modalidade-info">
                                    <img src="<%= modalidadeInfo.logo %>" alt="<%= modalidadeInfo.nome %>" class="jogo-modalidade-logo">
                                    <span class="jogo-modalidade-nome"><%= modalidadeInfo.nome %></span>
                                </div>
                                <div class="jogo-preco">
                                    <span class="preco-label">ğŸ’°</span>
                                    <span class="preco-valor">R$ <%= modalidadeInfo.precoMinimo.toFixed(2).replace('.', ',') %></span>
                                </div>
                            </div>
                        </div>
                    
                    <div class="jogo-numeros">
                        <% 
                        const ehMaisMilionaria = jogo.modalidade === 'maismilionaria';
                        const ehDiaDeSorte = jogo.modalidade === 'diadesorte';
                        const ehTimemania = jogo.modalidade === 'timemania';
                        const numeros = jogo.numeros || [];
                        const numerosPrincipais = ehMaisMilionaria && numeros.length >= 8 ? numeros.slice(0, -2) : numeros;
                        const trevos = ehMaisMilionaria && numeros.length >= 8 ? numeros.slice(-2) : [];
                        
                        // Mostrar atÃ© 6 nÃºmeros
                        const numerosVisiveis = numerosPrincipais.slice(0, 6);
                        const temMais = numerosPrincipais.length > 6;

                        // Texto para o botÃ£o 'copiar' (preparado aqui para evitar expressÃµes complexas inline)
                        const copiarTexto = ehMaisMilionaria && trevos.length > 0 ? numerosPrincipais.join(', ') + ' | Trevos: ' + trevos.join(', ') : (jogo.numeros || []).join(', ');
                        
                        numerosVisiveis.forEach(numero => { %>
                            <span class="numero-mini"><%= String(numero).padStart(2, '0') %></span>
                        <% }); 
                        
                        if (temMais) { 
                            // Preparar dados para o popup
                            const extrasJson = JSON.stringify({
                                trevos: trevos,
                                mesDaSorte: ehDiaDeSorte && jogo.mesDaSorte ? jogo.mesDaSorte : null,
                                timeCoracao: ehTimemania && jogo.timeCoracao ? jogo.timeCoracao : null
                            }).replace(/"/g, '&quot;');
                        %>
                                <span class="numero-mini mais" 
                                    onclick="mostrarTodosNumeros('<%= index + 1 %>', JSON.parse(decodeURIComponent('<%= encodeURIComponent(JSON.stringify(numerosPrincipais)) %>')), decodeURIComponent('<%= encodeURIComponent(modalidadeInfo.nome) %>'), JSON.parse(decodeURIComponent('<%= encodeURIComponent(JSON.stringify({ trevos: trevos, mesDaSorte: ehDiaDeSorte && jogo.mesDaSorte ? jogo.mesDaSorte : null, timeCoracao: ehTimemania && jogo.timeCoracao ? jogo.timeCoracao : null })) %>')) )">
                                ...
                            </span>
                        <% } %>

                        <% if (trevos.length > 0) { %>
                            <span class="separador-trevos" style="color: #16397F; font-size: 1.5rem; font-weight: bold; margin: 0 0.5rem;">|</span>
                            <% trevos.forEach(trevo => { %>
                                <span class="numero-badge trevo-badge" style="background: linear-gradient(135deg, rgba(22, 57, 127, 0.85), rgba(22, 57, 127, 0.95)); border-color: rgba(22, 57, 127, 1); box-shadow: 0 0 10px rgba(22, 57, 127, 0.3);"><%= trevo %></span>
                            <% }); 
                        }
                        
                        if (ehDiaDeSorte && jogo.mesDaSorte) { %>
                            <span class="separador-mes" style="color: #CB852B; font-size: 1.5rem; font-weight: bold; margin: 0 0.5rem;">|</span>
                            <span class="mes-sorte-badge" style="background: linear-gradient(135deg, rgba(203, 133, 43, 0.85), rgba(203, 133, 43, 0.95)); border-color: rgba(203, 133, 43, 1); color: #fff; padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; font-weight: bold;">ğŸ“… <%= jogo.mesDaSorte %></span>
                        <% }
                        
                        if (ehTimemania && jogo.timeCoracao) { %>
                            <span class="separador-time" style="color: #00FF48; font-size: 1.5rem; font-weight: bold; margin: 0 0.5rem;">|</span>
                            <span class="time-coracao-badge" style="background: linear-gradient(135deg, rgba(0, 255, 72, 0.85), rgba(0, 255, 72, 0.95)); border-color: rgba(0, 255, 72, 1); color: #000; padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.9rem; font-weight: bold;">âš½ <%= jogo.timeCoracao %></span>
                        <% } %>
                    </div>
                    
                    <div class="jogo-actions">
                        <button class="btn-copiar" onclick="copiarNumeros(decodeURIComponent('<%= encodeURIComponent(copiarTexto) %>'))" title="Copiar nÃºmeros">
                            ğŸ“‹ Copiar
                        </button>
                        <button class="btn-deletar" onclick="deletarJogo('<%= jogo._id %>')" title="Deletar sequÃªncia">
                            ğŸ—‘ï¸ Deletar
                        </button>
                    </div>
                </div>
            <% }); %>
        </div>

        <div class="jogos-footer">
            <button class="btn-deletar-todos" onclick="deletarTodas()" title="Deletar todas as sequÃªncias">
                ğŸ—‘ï¸ Deletar Todas as SequÃªncias
            </button>
        </div>
    <% } %>
    
    <!-- EstatÃ­sticas de Acertos -->
    <div id="estatisticas-acertos" class="estatisticas-acertos">
        <h3 class="estatisticas-titulo">ğŸ“Š EstatÃ­sticas de Acertos</h3>
        <div class="estatisticas-grid">
            <div class="estatistica-item" data-acertos="0">
                <div class="estatistica-numero">0</div>
                <div class="estatistica-label">acertos</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="1">
                <div class="estatistica-numero">1</div>
                <div class="estatistica-label">acerto</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="2">
                <div class="estatistica-numero">2</div>
                <div class="estatistica-label">acertos</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="3">
                <div class="estatistica-numero">3</div>
                <div class="estatistica-label">acertos</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="4">
                <div class="estatistica-numero">4</div>
                <div class="estatistica-label">acertos</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="5">
                <div class="estatistica-numero">5</div>
                <div class="estatistica-label">acertos</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">sequÃªncias</div>
            </div>
            <div class="estatistica-item" data-acertos="6">
                <div class="estatistica-numero">6</div>
                <div class="estatistica-label">acertos ğŸ†</div>
                <div class="estatistica-count">0</div>
                <div class="estatistica-descricao">VENCEDORAS!</div>
            </div>
        </div>
    </div>
    
    <div class="volta-home">
        <a href="/" class="btn-voltar">â† Voltar Ã  PÃ¡gina Principal</a>
    </div>
</main>

<%- include('includes/footer'); %>